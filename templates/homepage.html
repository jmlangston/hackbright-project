<!doctype html>
<html>
<head>
    <title>WorldWise</title>

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

    <script src='https://api.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet'/>

    <style>
      body { margin: 10; }
      #map { float: left; width: 70%; height: 600px; }
      #sidebar { float: right; width: 25%; height: 600px; overflow: scroll; }
    </style>

</head>

<body>

    <div id="sidebar">
    {% with messages = get_flashed_messages() %}
        {% for message in messages %}
            <div class="alert">{{ message }}
            </div>
        {% endfor %}
    {% endwith %}



        <!-- <h1>What's going on in the world?</h1> -->
        <!-- <h3>Let's find out!</h3> -->

        <!-- <ul> -->
            <!-- {% for location in locations %} -->
                <!-- <li> -->
                <!-- <a href="/articles/{{ location.location_id }}"> -->
                        <!-- {{ location.location_name.title() }} -->
                        <!-- .title() converts a string to Title Case
                    </a>
                </li>
            {% endfor %}
        </ul>
 -->    </div>

    <div id="map">
    </div>

    <!-- // <script src="sidebar.js"></script> -->

    <script>

        var sidebar = document.getElementById("sidebar");
        sidebar.innerText = "Hello, World!";

        // TO DO: how to organize script into functions?
        
        // per Mapbox mentors, it's okay that this key is not secret
        L.mapbox.accessToken = 'pk.eyJ1Ijoiam1sYW5nc3RvbiIsImEiOiI1MGFhMGUzZmFjOTJjMmFkYTVjZTQ0MDExYjQ4NzhkYyJ9.xjCipe1mRK_lbjkQruXkvA';
        
        // Instantiate map.  First arg is the html element id ('map').
        // Second arg is the specific map. Right now is a default Mapbox streets map. Later can replace this with map I design in Mapbox Studio.
        var map = L.mapbox.map('map', 'mapbox.streets', {
            scrollWheelZoom: false
            }).setView([20, 0], 2);

        // to adjust setView...
        // setView([lat, long], zoom)  <- zoom cannot be a decimal

        var popupsLayer = L.mapbox.featureLayer().addTo(map);

        popupsLayer.on('layeradd', function(evt) {
            // console.log(evt)
            var marker = evt.layer
            var feature = marker.feature

            var popupContent = 
                '<h1>' + feature.properties.title + '</h1><ul><li><a href="' + feature.properties.article_1_url + '">' + feature.properties.article_1_headline + '</a> ' + feature.properties.article_1_date + '</li><li><a href="' + feature.properties.article_2_url + '">' + feature.properties.article_2_headline + '</a> ' + feature.properties.article_2_date + '</li><li><a href="' + feature.properties.article_3_url + '">' + feature.properties.article_3_headline + '</a> ' + feature.properties.article_3_date + '</li></ul><button type="button" class="popup-btn" id="btn">View More Articles!</button>'

            console.log(feature.properties.articles)

            // I took this out of popupContent and replaced it with a button
            // <a href="' + feature.properties.articleUrl + '">View More Articles</a>'

            marker.bindPopup(popupContent)
        })

        popupsLayer.setGeoJSON({{ marker_collection | safe }});

        // geoJSON documentation: http://geojson.org/geojson-spec.html
        // NOTE: geoJSON [LONGITUDE, LATITUDE]


        // Map events documentation
        // https://www.mapbox.com/mapbox.js/api/v2.2.1/l-map-class/#map-events
        

        // WOULD THIS WORK?
        // answer: No, because geoj contains 10 locations...
        // map.on('popupopen', function(evt){
        //     $('.popup-btn').click(function(){
        //         geoj = popupsLayer.getGeoJSON();
        //         route = geoj.features.properties.articleUrl
        //         $.get( "/articles/" + city_id, function(results){
        //             $('#sidebar').html(results);
        //         });
        //     });
        // });


        // THIS WORKS!

        map.on('popupopen', function(evt){
            console.log("Popup opened!");
            $('.popup-btn').click(function(){
                console.log("Button clicked!");
                c = evt.popup.getContent();
                // console.log(c);
                // console.log(typeof c);
                c_str = c.slice(4,20);
                c_end = c_str.search("<");
                city = c_str.slice(0,c_end);
                console.log("CITY: " + city);
                geoj = popupsLayer.getGeoJSON();
                // console.log(g);
                // console.log(typeof marker_collection);
                // var marker = evt.popup.getContent();
                // console.log(marker);
                // f = popupsLayer.feature;
                // console.log("FEATURE: " + f);

                // console.log("Type of geoj:" + typeof geoj);
                // console.log("geoj: " geoj);
                console.log("geoj.features.length: ", geoj.features.length);
                city_id = 0;
                for (var i = 0; i < geoj.features.length; i++) {
                    // console.log(geoj.features[i].properties.title);
                    if (city == geoj.features[i].properties.title) {
                        console.log(geoj.features[i].properties.title, geoj.features[i].properties.description);
                        cityUrl = geoj.features[i].properties.articleUrl;
                    };
                };
                // if (city_id != 0) {
                //     window.location = '/articles/' + city_id;
                // } else {
                //     window.location = '/';
                // }

                // AJAX 
                $.get(cityUrl, function(results){
                    $('#sidebar').html(results);
                });
            });
        });

        // basic - how to add a marker
        // L.marker([40.712784, -74.005941]).addTo(map); // NEW YORK CITY




    </script>

</body>

</html>
