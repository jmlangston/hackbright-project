<!doctype html>
<html>
<head>
    <title>Jessica's Project</title>

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

    <script src='https://api.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet'/>

    <style>
      body { margin: 10; }
      #map { float: left; width: 70%; height: 500px; }
      #sidebar { float: right; width: 25%; }
    </style>

</head>

<body>

    <div id="sidebar">
        <h1>What's going on in the world?</h1>
        <h3>Let's find out!</h3>

        <ul>
            {% for location in locations %}
                <li>
                <a href="/articles/{{ location.location_id }}">
                        {{ location.location_name.title() }}
                        <!-- .title() converts a string to Title Case -->
                    </a>
                </li>
            {% endfor %}
        </ul>
    </div>

    <div id="map">
    </div>

    <script>

        // TO DO: organize script into functions?
        
        // per Mapbox mentors, it's okay that this key is not secret
        L.mapbox.accessToken = 'pk.eyJ1Ijoiam1sYW5nc3RvbiIsImEiOiI1MGFhMGUzZmFjOTJjMmFkYTVjZTQ0MDExYjQ4NzhkYyJ9.xjCipe1mRK_lbjkQruXkvA';
        
        // Instantiate map.  First arg is the html element id ('map').
        // Second arg is the specific map. Right now is a default Mapbox streets map. Later can replace this with map I design in Mapbox Studio.
        var map = L.mapbox.map('map', 'mapbox.streets', {
            scrollWheelZoom: false
            }).setView([0, 0], 1);

        // TO DO: adjust setView
        // setView([lat, long], zoom)  <- zoom cannot be a decimal

        var popupsLayer = L.mapbox.featureLayer().addTo(map);

        popupsLayer.on('layeradd', function(evt) {
            // console.log(evt)
            var marker = evt.layer
            var feature = marker.feature

            var popupContent = '<h1>' + feature.properties.title + '</h1><h3>' + feature.properties.articles + '</h3><button type="button" class="popup-btn" id="btn">View More Articles!</button>'

            // I took this out of popupContent and replaced it with a button
            // <a href="' + feature.properties.articleUrl + '">View More Articles</a>'

            marker.bindPopup(popupContent)
        })

        popupsLayer.setGeoJSON({{ marker_collection | safe }});


        // Map events documentation
        // https://www.mapbox.com/mapbox.js/api/v2.2.1/l-map-class/#map-events
        map.on('popupopen', function(evt){
            console.log("Popup opened!");
            $('.popup-btn').click(function(){
                console.log("Button clicked!");
                c = evt.popup.getContent();
                // console.log(c);
                // console.log(typeof c);
                c_str = c.slice(4,20);
                c_end = c_str.search("<");
                city = c_str.slice(0,c_end);
                console.log("CITY: " + city);
                geoj = popupsLayer.getGeoJSON();
                // console.log(g);
                // console.log(typeof marker_collection);
                // var marker = evt.popup.getContent();
                // console.log(marker);
                // f = popupsLayer.feature;
                // console.log("FEATURE: " + f);

                console.log(typeof geoj);
                console.log(geoj);
                console.log("geoj.features.length: ", geoj.features.length);
                city_id = 0;
                for (var i = 0; i < geoj.features.length; i++) {
                    // console.log(geoj.features[i].properties.title);
                    if (city == geoj.features[i].properties.title) {
                        console.log(geoj.features[i].properties.title, geoj.features[i].properties.description);
                        city_id = geoj.features[i].properties.description;
                    }
                }
                // if (city_id != 0) {
                //     window.location = '/articles/' + city_id;
                // } else {
                //     window.location = '/';
                // }

                // AJAX 
                $.get( "/articles/" + city_id, function(results){
                    $('#sidebar').html(results);
                });
            });
        });

            // USE THIS:
            // marker.on('click', '.popup-btn', showArticles()


        // function showArticles(evt):
        //     $.get('/articles/1', {'marker': marker}, function(results){
        //         $('#sidebar').html(results);
        //     })

        // playing around with jQuery
        // $(document).ready(function(){
        //     console.log("HELLO!")
        //     console.log($('#btn'))
        //     $('.popup-btn').click(function(){
        //         console.log("HI!")
        //         $('#sidebar').hide();
        //     })
        // })
  
        // testing jquery. hides and shows sidebar when mouseenter and
        // mouseleave the map div.

        // $(document).ready(function(){
        //     $('#map').mouseenter(function(){
        //         $('#sidebar').hide();
        //     });
        //     $('#map').mouseleave(function(){
        //         $('#sidebar').show();
        //     })
        // })

        // L.marker([40.712784, -74.005941]).addTo(map); // NEW YORK CITY
        // L.marker([37.774929, -122.419416]).addTo(map); // SAN FRANCISCO
        // L.marker([41.878114, -87.629798]).addTo(map); // CHICAGO
        // L.marker([38.907192, -77.036871]).addTo(map); // WASHINGTON (DC)
        // L.marker([51.507351, -0.127758]).addTo(map); // LONDON
        // L.marker([48.856614, 2.352222]).addTo(map); // PARIS
        // L.marker([39.904211, 116.407395]).addTo(map); // BEIJING
        // L.marker([19.432608, -99.133208]).addTo(map); // MEXICO CITY
        // L.marker([-34.603684, -58.381559]).addTo(map); // BUENOS AIRES
        // L.marker([30.044420|31.235712]).addTo(map); // CAIRO


        // geoJSON documentation: http://geojson.org/geojson-spec.html

        // NOTE: geoJSON [LONGITUDE, LATITUDE]

        // var geojson = [
        //     {
        //         "type": "Feature",
        //         "geometry": {
        //             "type": "Point",
        //             "coordinates": [-122.419416, 37.774929]
        //         },
        //         "properties": {
        //             "title": "TEST TOOLTIP #1!!!"
        //         }
        //     },
        //     {
        //         "type": "Feature",
        //         "geometry": {
        //             "type": "Point",
        //             "coordinates": [-74.005941, 40.712784]
        //         },
        //         "properties": {
        //             "title": "TEST TOOLTIP #2!!!"
        //         }
        //     }
        // ]

    </script>

</body>

</html>
